<!-- Header with Period Filter -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="h3 mb-0 text-gray-800">
    <i class="bi bi-graph-up"></i> Dashboard Gerencial
  </h1>
  <div class="d-flex gap-2">
    <a href="/export" class="btn btn-success btn-sm" title="Exportar dados para CSV">
      <i class="bi bi-download"></i> Exportar CSV
    </a>
    <select id="periodFilter" class="form-select" style="width: auto;">
      <option value="7d" <%= selectedPeriod === '7d' ? 'selected' : '' %>>Últimos 7 dias</option>
      <option value="30d" <%= selectedPeriod === '30d' ? 'selected' : '' %>>Últimos 30 dias</option>
      <option value="90d" <%= selectedPeriod === '90d' ? 'selected' : '' %>>Últimos 90 dias</option>
      <option value="all" <%= selectedPeriod === 'all' ? 'selected' : '' %>>Todo período</option>
    </select>
  </div>
</div>

<!-- KPI Cards - Compact Design -->
<div class="row g-2 mb-3">
  <!-- Card: Chamados Abertos -->
  <div class="col-xl-3 col-md-6">
    <div class="kpi-card kpi-primary">
      <div class="kpi-content">
        <div class="kpi-icon-wrapper">
          <i class="bi bi-inbox-fill"></i>
        </div>
        <div class="kpi-details">
          <div class="kpi-value"><%= kpis.totalOpen %></div>
          <div class="kpi-label">Chamados Abertos</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Card: Tempo Médio de Resposta -->
  <div class="col-xl-3 col-md-6">
    <div class="kpi-card kpi-info">
      <div class="kpi-content">
        <div class="kpi-icon-wrapper">
          <i class="bi bi-clock-history"></i>
        </div>
        <div class="kpi-details">
          <div class="kpi-value"><%= kpis.avgResponseTime %>h</div>
          <div class="kpi-label">Tempo Médio Resposta</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Card: Taxa de Cumprimento SLA -->
  <div class="col-xl-3 col-md-6">
    <div class="kpi-card <%= kpis.slaRate >= 95 ? 'kpi-success' : (kpis.slaRate >= 85 ? 'kpi-warning' : 'kpi-danger') %>">
      <div class="kpi-content">
        <div class="kpi-icon-wrapper">
          <i class="bi bi-<%= kpis.slaRate >= 95 ? 'check-circle-fill' : (kpis.slaRate >= 85 ? 'exclamation-triangle-fill' : 'x-circle-fill') %>"></i>
        </div>
        <div class="kpi-details">
          <div class="kpi-value"><%= kpis.slaRate %>%</div>
          <div class="kpi-label">Taxa SLA</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Card: Alertas Críticos -->
  <div class="col-xl-3 col-md-6">
    <div class="kpi-card <%= kpis.criticalAlerts > 0 ? 'kpi-danger' : 'kpi-success' %>">
      <div class="kpi-content">
        <div class="kpi-icon-wrapper">
          <i class="bi bi-<%= kpis.criticalAlerts > 0 ? 'exclamation-diamond-fill' : 'shield-check' %>"></i>
        </div>
        <div class="kpi-details">
          <div class="kpi-value"><%= kpis.criticalAlerts %></div>
          <div class="kpi-label">Alertas Críticos</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- USFs e Categorias -->
<div class="row g-2 mb-3">
  <!-- Widget: USFs Problemáticas -->
  <div class="col-lg-6">
    <div class="widget-card">
      <div class="widget-header">
        <h5 class="widget-title"><i class="bi bi-hospital"></i> USFs Problemáticas</h5>
        <span class="widget-subtitle">Top 5 - Últimos 30 dias</span>
      </div>
      <div class="widget-body">
        <% if (topUsfs.length === 0) { %>
          <p class="text-center text-muted py-4">Nenhum dado disponível</p>
        <% } else { %>
          <ul class="ranking-list">
            <% topUsfs.forEach((usf, index) => { %>
              <li class="ranking-item">
                <span class="rank">#<%= index + 1 %></span>
                <div class="ranking-info">
                  <div class="ranking-name"><%= usf.nome %></div>
                  <div class="ranking-meta">
                    <% if (usf.urgentes > 0) { %>
                      <span class="meta-tag meta-urgent"><%= usf.urgentes %> urgentes</span>
                    <% } %>
                    <% if (usf.sla_breach > 0) { %>
                      <span class="meta-tag meta-breach"><%= usf.sla_breach %> SLA vencido</span>
                    <% } %>
                  </div>
                </div>
                <span class="badge <%= usf.total_chamados > 20 ? 'bg-danger' : (usf.total_chamados > 10 ? 'bg-warning text-dark' : 'bg-secondary') %>">
                  <%= usf.total_chamados %>
                </span>
              </li>
            <% }) %>
          </ul>
        <% } %>
      </div>
    </div>
  </div>

  <!-- Widget: Categorias Quentes -->
  <div class="col-lg-6">
    <div class="widget-card">
      <div class="widget-header">
        <h5 class="widget-title"><i class="bi bi-fire"></i> Categorias Quentes</h5>
        <span class="widget-subtitle">Top 5 - Últimos 30 dias</span>
      </div>
      <div class="widget-body">
        <% if (topCategories.length === 0) { %>
          <p class="text-center text-muted py-4">Nenhum dado disponível</p>
        <% } else { %>
          <ul class="ranking-list">
            <% topCategories.forEach((cat, index) => { %>
              <li class="ranking-item">
                <span class="rank">#<%= index + 1 %></span>
                <div class="ranking-info">
                  <div class="ranking-name"><%= cat.nome %></div>
                  <div class="ranking-meta">
                    <span class="meta-tag"><%= cat.percentage %>% do total</span>
                  </div>
                </div>
                <span class="badge bg-primary"><%= cat.total %></span>
              </li>
            <% }) %>
          </ul>
        <% } %>
      </div>
    </div>
  </div>
</div>

<!-- Gráfico e Estoque -->
<div class="row g-2 mb-3">
  <!-- Chart: Volume por USF -->
  <div class="col-lg-8">
    <div class="widget-card">
      <div class="widget-header">
        <h5 class="widget-title"><i class="bi bi-bar-chart-fill"></i> Volume por Unidade de Saúde</h5>
        <span class="widget-subtitle">Últimos 30 dias</span>
      </div>
      <div class="widget-body">
        <div class="chart-container">
          <canvas id="myBarChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Panel: Estoque Crítico -->
  <div class="col-lg-4">
    <div class="widget-card">
      <div class="widget-header">
        <h5 class="widget-title"><i class="bi bi-box-seam"></i> Estoque Crítico</h5>
        <span class="widget-subtitle">Itens com quantidade baixa</span>
      </div>
      <div class="widget-body p-0">
        <ul class="list-group list-group-flush">
          <% if (lowStock.length === 0) { %>
            <li class="list-group-item text-center text-muted">
              <i class="bi bi-check-circle text-success"></i> Estoque abastecido
            </li>
          <% } else { %>
            <% lowStock.forEach(item => { %>
              <li class="list-group-item d-flex justify-content-between align-items-center <%= item.quantidadeAtual === 0 ? 'bg-danger bg-opacity-10' : '' %>">
                <div>
                  <strong class="<%= item.quantidadeAtual === 0 ? 'text-danger' : '' %>">
                    <%= item.nome %>
                  </strong>
                  <% if (item.quantidadeAtual === 0) { %>
                    <br><small class="text-danger"><i class="bi bi-exclamation-triangle-fill"></i> Estoque zerado!</small>
                  <% } %>
                </div>
                <span class="badge <%= item.quantidadeAtual === 0 ? 'bg-danger' : 'bg-warning text-dark' %> rounded-pill">
                  <%= item.quantidadeAtual %>
                </span>
              </li>
            <% }) %>
          <% } %>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- Alertas removidos - informações disponíveis na sidebar -->

<!-- Analytics Tabs (Compact) -->
<div class="row g-2 mb-3">
  <div class="col-12">
    <div class="widget-card">
      <div class="widget-header pb-0">
        <ul class="nav nav-tabs dashboard-tabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="trend-tab" data-bs-toggle="tab" data-bs-target="#trend-panel" type="button" role="tab">
              <i class="bi bi-graph-up"></i> Tendência
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="workload-tab" data-bs-toggle="tab" data-bs-target="#workload-panel" type="button" role="tab">
              <i class="bi bi-people-fill"></i> Carga de Trabalho
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="sla-tab" data-bs-toggle="tab" data-bs-target="#sla-panel" type="button" role="tab">
              <i class="bi bi-clock-history"></i> Performance SLA
            </button>
          </li>
        </ul>
      </div>
      
      <div class="tab-content widget-body pt-3">
        <!-- Trend Tab -->
        <div class="tab-pane fade show active" id="trend-panel" role="tabpanel">
          <p class="text-muted small mb-3"><i class="bi bi-info-circle"></i> Volume de chamados nos últimos 7 dias</p>
          <div class="chart-container" style="height: 220px;">
            <canvas id="trendChart"></canvas>
          </div>
        </div>
        
        <!-- Workload Tab -->
        <div class="tab-pane fade" id="workload-panel" role="tabpanel">
          <p class="text-muted small mb-3"><i class="bi bi-info-circle"></i> Chamados ativos por técnico</p>
          <% if (techWorkload.length === 0) { %>
            <p class="text-center text-muted py-4">Nenhum técnico com chamados ativos</p>
          <% } else { %>
            <ul class="ranking-list">
              <% techWorkload.forEach((tech, index) => { %>
                <li class="ranking-item">
                  <span class="rank">#<%= index + 1 %></span>
                  <div class="ranking-info">
                    <div class="ranking-name"><%= tech.nome %></div>
                    <div class="ranking-meta">
                      <% if (tech.urgentes > 0) { %>
                        <span class="meta-tag meta-urgent"><%= tech.urgentes %> urgentes</span>
                      <% } %>
                      <span class="meta-tag"><i class="bi bi-clock"></i> <%= tech.tempo_resposta_medio %>h resposta</span>
                    </div>
                  </div>
                  <span class="badge <%= tech.chamados_ativos > 15 ? 'bg-danger' : (tech.chamados_ativos > 10 ? 'bg-warning text-dark' : 'bg-success') %>">
                    <%= tech.chamados_ativos %>
                  </span>
                </li>
              <% }) %>
            </ul>
          <% } %>
        </div>
        
        <!-- SLA Tab -->
        <div class="tab-pane fade" id="sla-panel" role="tabpanel">
          <p class="text-muted small mb-3"><i class="bi bi-info-circle"></i> Detalhamento de cumprimento de SLA</p>
          <div class="sla-metrics">
            <div class="sla-metric-item">
              <div class="sla-metric-label">Taxa de Cumprimento</div>
              <div class="sla-metric-value <%= slaDetails.taxa_cumprimento >= 95 ? 'text-success' : (slaDetails.taxa_cumprimento >= 85 ? 'text-warning' : 'text-danger') %>">
                <%= slaDetails.taxa_cumprimento %>%
              </div>
              <div class="sla-metric-meta">Meta: 95%</div>
            </div>
            
            <div class="row mt-3">
              <div class="col-6">
                <div class="sla-stat-card bg-success bg-opacity-10">
                  <div class="sla-stat-value text-success"><%= slaDetails.no_prazo %></div>
                  <div class="sla-stat-label">No Prazo</div>
                </div>
              </div>
              <div class="col-6">
                <div class="sla-stat-card bg-danger bg-opacity-10">
                  <div class="sla-stat-value text-danger"><%= slaDetails.atrasados %></div>
                  <div class="sla-stat-label">Atrasados</div>
                </div>
              </div>
            </div>

            <div class="row mt-2">
              <div class="col-6">
                <div class="sla-time-metric">
                  <span class="sla-time-label">Tempo Médio Resposta:</span>
                  <span class="sla-time-value"><%= slaDetails.tempo_medio_resposta %>h</span>
                </div>
              </div>
              <div class="col-6">
                <div class="sla-time-metric">
                  <span class="sla-time-label">Tempo Médio Resolução:</span>
                  <span class="sla-time-value"><%= slaDetails.tempo_medio_resolucao %>h</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js (local) -->
<script src="/node_modules/chart.js/dist/chart.umd.js"></script>

<!-- Tab Initialization Script (external file to comply with CSP) -->
<script src="/public/dashboard-tabs.js"></script>

<!-- Chart Data (embedded in data attributes for CSP compliance) -->
<div id="chartData" style="display: none;"
     data-usf='<%- JSON.stringify(byUsf) %>'
     data-trend='<%- JSON.stringify(trendData) %>'>
</div>

<!-- External Chart Scripts (CSP compliant) -->
<script src="/public/dashboard-charts.js"></script>
