<h1 class="h3 mb-4 text-gray-800">
  <i class="bi bi-people text-primary"></i> Gerenciar Usuários
</h1>

<!-- Formulário de Novo Usuário -->
<div class="card shadow mb-4">
  <div class="card-header py-3 bg-gradient-primary">
    <h6 class="m-0 font-weight-bold text-white">
      <i class="bi bi-person-plus"></i> Novo Usuário
    </h6>
  </div>
  <div class="card-body">
    <form method="post" action="/admin/users">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">

      <div class="row">
        <div class="col-md-6 mb-3">
          <label class="form-label fw-semibold">
            <i class="bi bi-person"></i> Nome Completo
          </label>
          <input class="form-control" name="nome" required placeholder="Ex: João Silva">
        </div>

        <div class="col-md-3 mb-3">
          <label class="form-label fw-semibold">
            <i class="bi bi-at"></i> Login
          </label>
          <input class="form-control" name="login" required placeholder="joao.silva">
        </div>

        <div class="col-md-3 mb-3">
          <label class="form-label fw-semibold">
            <i class="bi bi-telephone"></i> Telefone
          </label>
          <input class="form-control" name="telefone" placeholder="(00) 00000-0000">
        </div>
      </div>

      <div class="row">
        <div class="col-md-4 mb-3">
          <label class="form-label fw-semibold">
            <i class="bi bi-briefcase"></i> Cargo
          </label>
          <input class="form-control" name="cargo" required placeholder="Ex: Enfermeiro, Recepcionista">
          <div class="form-text">
            <i class="bi bi-info-circle"></i> Se "Enfermeiro", pode virar Coordenador automaticamente
          </div>
        </div>

        <div class="col-md-4 mb-3">
          <label class="form-label fw-semibold">
            <i class="bi bi-building"></i> Unidade (USF)
          </label>
          <select class="form-select" name="usfId" required>
            <option value="">Selecione...</option>
            <% usfs.forEach(u => { %>
              <option value="<%= u.id %>"><%= u.nome %></option>
            <% }) %>
          </select>
        </div>

        <div class="col-md-2 mb-3">
          <label class="form-label fw-semibold">
            <i class="bi bi-shield"></i> Perfil
          </label>
          <select class="form-select" name="role">
            <option value="REQUESTER">Solicitante</option>
            <option value="COORDINATOR">Coordenador</option>
            <option value="TECH">Técnico TI</option>
            <option value="ADMIN">Admin</option>
          </select>
        </div>

        <div class="col-md-2 mb-3">
          <label class="form-label fw-semibold">
            <i class="bi bi-key"></i> Senha
          </label>
          <input class="form-control" type="password" name="password" required placeholder="••••••">
        </div>
      </div>

      <div class="d-grid gap-2 d-md-flex justify-content-md-end">
        <button class="btn btn-primary" type="submit">
          <i class="bi bi-check-circle"></i> Cadastrar Usuário
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Lista de Usuários -->
<div class="card shadow">
  <div class="card-header py-3">
    <h6 class="m-0 font-weight-bold text-primary">
      <i class="bi bi-list-ul"></i> Usuários Cadastrados
      <span class="badge bg-primary ms-2"><%= users.length %></span>
    </h6>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th class="ps-4">Usuário</th>
            <th>Login</th>
            <th>Cargo</th>
            <th>Unidade</th>
            <th>Perfil</th>
            <th>Status</th>
            <th class="text-end pe-4">Ações</th>
          </tr>
        </thead>
        <tbody>
          <% if (users.length === 0) { %>
            <tr>
              <td colspan="7" class="text-center py-5 text-muted">
                <i class="bi bi-people fs-1 d-block mb-2"></i>
                Nenhum usuário cadastrado ainda.
              </td>
            </tr>
          <% } else { %>
            <% users.forEach(u => { %>
              <tr>
                <td class="ps-4">
                  <div class="d-flex align-items-center">
                    <div class="avatar-sm bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-3">
                      <i class="bi bi-person-fill text-primary"></i>
                    </div>
                    <div>
                      <div class="fw-semibold"><%= u.nome %></div>
                      <% if (u.telefone) { %>
                        <small class="text-muted">
                          <i class="bi bi-telephone"></i> <%= u.telefone %>
                        </small>
                      <% } %>
                    </div>
                  </div>
                </td>
                <td>
                  <code class="text-dark"><%= u.login %></code>
                </td>
                <td>
                  <span class="text-secondary"><%= u.cargo %></span>
                </td>
                <td>
                  <% if (u.usf) { %>
                    <span class="badge bg-light text-dark border">
                      <i class="bi bi-building"></i> <%= u.usf.nome %>
                    </span>
                  <% } %>
                </td>
                <td>
                  <% 
                    const roleColors = {
                      ADMIN: 'danger',
                      TECH: 'primary',
                      COORDINATOR: 'info',
                      REQUESTER: 'secondary'
                    };
                    const roleIcons = {
                      ADMIN: 'shield-fill-check',
                      TECH: 'tools',
                      COORDINATOR: 'person-badge',
                      REQUESTER: 'person'
                    };
                  %>
                  <span class="badge bg-<%= roleColors[u.role] || 'secondary' %>">
                    <i class="bi bi-<%= roleIcons[u.role] || 'person' %>"></i> <%= u.role %>
                  </span>
                </td>
                <td>
                  <% if (u.ativo) { %>
                    <span class="badge bg-success">
                      <i class="bi bi-check-circle"></i> Ativo
                    </span>
                  <% } else { %>
                    <span class="badge bg-warning text-dark">
                      <i class="bi bi-pause-circle"></i> Inativo
                    </span>
                  <% } %>
                </td>
                <td class="text-end pe-4">
                  <form method="post" action="/admin/users/<%= u.id %>/toggle" class="d-inline">
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                    <button class="btn btn-sm btn-outline-<%= u.ativo ? 'warning' : 'success' %>" type="submit"
                            data-bs-toggle="tooltip" title="<%= u.ativo ? 'Desativar' : 'Ativar' %>">
                      <i class="bi bi-<%= u.ativo ? 'pause' : 'play' %>-circle"></i>
                    </button>
                  </form>
                </td>
              </tr>
            <% }) %>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<style>
.avatar-sm {
  width: 40px;
  height: 40px;
}
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });
  });
</script>
