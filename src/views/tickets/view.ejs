<div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
  <div>
    <h1 class="h4 mb-1">Chamado #<%= ticket.id %>
    </h1>
    <div class="text-secondary small">
      USF: <%= ticket.usf?.nome %> • Sala: <%= ticket.room %> • Categoria: <%= ticket.category?.nome %>
    </div>
  </div>

  <div class="d-flex gap-2 flex-wrap">
    <span class="badge <%= statusBadgeClass(ticket.status) %>">Status: <%= translateStatus(ticket.status) %></span>
    <span class="badge <%= priorityBadgeClass(ticket.priority) %>">Prioridade: <%= translatePriority(ticket.priority) %>
        </span>
    <% if (ticket.assignee) { %>
      <span class="badge text-bg-light border">Responsável: <%= ticket.assignee.nome %></span>
      <% } %>
  </div>
</div>

<div class="card mb-3">
  <div class="card-body">
    <div class="fw-semibold mb-1">
      <%= ticket.title %>
    </div>
    <div class="text-secondary small">
      SLA 1ª resposta até: <%= fmtDateBR(ticket.responseDueAt) %>
        <% if (ticket.responseBreachedAt) { %> • <span class="text-danger">Estourado</span>
          <% } %>
            <% if (ticket.firstResponseAt) { %> • Respondido: <%= fmtDateBR(ticket.firstResponseAt) %>
                <% } %>
    </div>
    <div class="text-secondary small">
      SLA resolução até: <%= fmtDateBR(ticket.resolutionDueAt) %>
        <% if (ticket.resolutionBreachedAt) { %> • <span class="text-danger">Estourado</span>
          <% } %>
            <% if (ticket.slaPausedAt) { %> • <span class="text-warning">Pausado</span>
              <% } %>
                <% if (ticket.resolvedAt) { %> • Resolvido: <%= fmtDateBR(ticket.resolvedAt) %>
                    <% } %>
    </div>
  </div>
</div>

<div class="row g-3">
  <div class="col-12 col-lg-7">
    <div class="card">
      <div class="card-header fw-semibold">Mensagens</div>
      <div class="card-body">
        <% ticket.messages.forEach(m=> { %>
          <% if (m.visibility==='INTERNAL' && !(user.role==='TECH' || user.role==='ADMIN' )) { return; } %>

            <div class="mb-3">
              <div class="d-flex justify-content-between flex-wrap gap-2">
                <div class="fw-semibold">
                  <%= m.author.nome %>
                    <span class="badge text-bg-light border">
                      <%= m.author.role %>
                    </span>
                    <% if (m.visibility==='INTERNAL' ) { %>
                      <span class="badge text-bg-warning">Interno</span>
                      <% } %>
                </div>
                <div class="text-secondary small">
                  <%= fmtDateBR(m.createdAt) %>
                </div>
              </div>
              <div class="mt-2 p-3 bg-light border rounded-3">
                <%= m.body %>
              </div>
            </div>
            <% }) %>
      </div>
    </div>

    <div class="card mt-3">
      <div class="card-header fw-semibold">Anexos</div>
      <div class="card-body">
        <% if (!ticket.attachments.length) { %>
          <div class="text-secondary">Sem anexos.</div>
          <% } else { %>
            <ul class="list-group">
              <% ticket.attachments.forEach(a=> { %>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <div>
                    <div class="fw-semibold">
                      <%= a.originalName %>
                    </div>
                    <div class="text-secondary small">
                      <%= Math.round(a.sizeBytes/1024) %> KB
                    </div>
                  </div>
                  <a class="btn btn-sm btn-outline-primary"
                    href="/tickets/<%= ticket.id %>/attachments/<%= a.id %>">Baixar</a>
                </li>
                <% }) %>
            </ul>
            <% } %>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-5">
    <div class="card">
      <div class="card-header fw-semibold">Comentar</div>
      <div class="card-body">
        <form method="post" action="/tickets/<%= ticket.id %>/message?_csrf=<%= csrfToken %>"
          enctype="multipart/form-data">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">

          <div class="mb-3">
            <label class="form-label">Mensagem</label>
            <textarea class="form-control" name="body" rows="5" required></textarea>
          </div>

          <% if (user.role==='TECH' || user.role==='ADMIN' ) { %>
            <div class="mb-3">
              <label class="form-label">Visibilidade</label>
              <select class="form-select" name="visibility">
                <option value="PUBLIC">Público</option>
                <option value="INTERNAL">Interno (só TI/Admin)</option>
              </select>
            </div>
            <% } %>

              <div class="mb-3">
                <label class="form-label">Anexos (opcional)</label>
                <input class="form-control" type="file" name="attachments" multiple />
              </div>

              <div class="d-grid">
                <button class="btn btn-primary" type="submit">Enviar</button>
              </div>
        </form>

        <% if (user.role==='TECH' ) { %>
          <hr class="my-3">
          <a class="btn btn-outline-secondary w-100" href="/tech/tickets/<%= ticket.id %>">Atender (TI)</a>
          <% } %>
      </div>
    </div>
  </div>
</div>